
[import "test"]
[import "midi"]

[[mdt *name *data : *commands] [ACCUMULATOR accu] [TestEq *name *data *x [res : *commands] [accu : *y] [REVERSE *y *x]] [accu]]

[[callback : *command] [accu *command]]

[TestFails "create empty source" [createSource]]
[createLine line1]
[createLine line2]
[createLine line3]
[createLine line4 callback]
[line1 connectThru line2]
[line2 line3]
[connectThru line3 line4]

[mdt "defaultDestination" [[keyon 1 61 101]] [defaultDestination] 
	[SELECT
		[[keyon 0 60 100]]
		[[keyon line1 1 61 101]]
	]
]
[mdt "defaultDestination line1" [[keyon 0 48 102]] [defaultDestination line1]
	[SELECT
		[[keyon 0 48 102]]
		[[keyon line1 1 49 103]]
	]
]

[mdt "midi_message"
	[[SYSEX 1 2 3] [polyaftertouch 5 2 3]]
	[midi_message 240 1 2 3 247] [midi_message 165 2 3]
]
[mdt "sysex" [[sysex 1 2 3]] [sysex 1 2 3]]
[mdt "SYSEX" [[SYSEX 1 2 3]] [SYSEX 1 2 3]]
[mdt "sysexch" [[sysex 1 2 3 45]] [sysexch 1 2 3]]
[mdt "SYSEXCH" [[SYSEX 1 2 3 122]] [SYSEXCH 1 2 3]]

[mdt "sysex line1" [[sysex 1 2 3]] [sysex line1 1 2 3]]
[mdt "SYSEX line2" [[SYSEX 1 2 3]] [SYSEX line2 1 2 3]]
[mdt "sysexch line3" [[sysex 1 2 3 45]] [sysexch line3 1 2 3]]
[mdt "SYSEXCH line4" [[SYSEX 1 2 3 122]] [SYSEXCH line4 1 2 3]]

[line4 midi_manufacturers_id]
[mdt "sysex" [[SYSEX 125 72 82 67 115 18 17 115 111 110 100 97]] [sysex 18 17 "sonda"]]

[TestEq "chex       56 32 : *" 40 *x [chex 56 32 : *x]]
[TestEq "chex line2 73 64 *" 41 *x [chex line2 73 32 *x]]
[TestEq "chex line3 73 : *" 9 *x [chex line3 73 : *x]]
[TestEq "chex       75 *" 11 *x [chex 75 *x]]
[mdt "sysex generated by midi_message" [[SYSEX 1 1026 3] [sysex 1025 2 3]] [midi_message 240 1 2 3 247] [midi_message 240 0 0 0 72 82 67 115 1 2 3 247]]

[line4 midi_manufacturers_id 0x7d]
[mdt "sysex chex" [[sysex 1302  17 115 111 110 100 97]] [sysex 0x516 0x11 "sonda"]]
[TestEq "chex *" 127 *x [chex *x]]
[defaultDestination line4]
[TestEq "chex *" 5 *x [chex *x]]
[defaultDestination line1]
[TestEq "chex line4 *" 5 *x [chex line4 *x]]
[mdt "SYSEX chex" [[SYSEX 126 1656 115 111 110 100 97]] [SYSEX 0x7e 0x678 "sonda"]]
[TestEq "chex : *" 127 *x [chex : *x]]
[TestEq "chex line4 : *" 6 *x [chex line4 : *x]]
[TestEq "chexer 0x567" [0x5 0x60 0x7] *x [chexer 0x567 : *x]]
[TestEq "chexer * 0x9 0x80 0x7" 0x987 *x [chexer *x 0x9 0x80 0x7]]

[line4 midi_manufacturers_id 0x43]
[mdt "YAMAHA sysex" [[SYSEX 0x43 1 2 3]] [midi_message 0xf3 0 240 0x43 1 2 3 247]]
[mdt "YAMAHA sysex with channel extension" [[SYSEX 0x43 2049 2 3]] [midi_message 0xf3 8 240 0x43 1 2 3 247]]
[mdt "YAMAHA-based HERCs sysex" [[sysex 1 2 3]] [midi_message 0xf3 0 240 0x43 "HRCs" 1 2 3 247]]
[mdt "YAMAHA-based HERCs sysex with channel extension" [[sysex 4097 2 3]] [midi_message 0xf3 16 240 0x43 "HRCs" 1 2 3 247]]


;[keyon 0 60 100]
;[attack 0 76]
;[ATTACK 0 76]

[exit]
